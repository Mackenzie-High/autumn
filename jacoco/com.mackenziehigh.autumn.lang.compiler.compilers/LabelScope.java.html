<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LabelScope.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.mackenziehigh:autumn</a> &gt; <a href="index.source.html" class="el_package">com.mackenziehigh.autumn.lang.compiler.compilers</a> &gt; <span class="el_source">LabelScope.java</span></div><h1>LabelScope.java</h1><pre class="source lang-java linenums">package com.mackenziehigh.autumn.lang.compiler.compilers;

import autumn.lang.compiler.ast.nodes.BranchStatement;
import autumn.lang.compiler.ast.nodes.GotoStatement;
import autumn.lang.compiler.ast.nodes.Label;
import autumn.lang.compiler.ast.nodes.MarkerStatement;
import com.google.common.base.Preconditions;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.mackenziehigh.autumn.resources.Finished;
import java.util.List;
import java.util.Map;
import org.objectweb.asm.tree.LabelNode;

/**
 * An instance of this class controls the allocation of location labels.
 *
 * &lt;p&gt;
 * This class also performs the checking of marker, goto, and branch statements.
 * Since a label can be declared at a point its usage, multiple compiler passes are needed.
 * However, we can get around that need by deferring the checking until the end of one pass.
 * In particular, we simply defer the checking until the end of the type-usage-checking pass.
 * Then, the label declarations and usages can be checked all at once.
 * &lt;/p&gt;
 *
 * @author Mackenzie High
 */
@Finished(&quot;2014/07/12&quot;)
final class LabelScope
{
    /**
     * This is essentially the program that is being compiled.
     */
    private final ProgramCompiler program;

    /**
     * This map maps the name of a label to its bytecode representation.
     */
<span class="fc" id="L39">    private final Map&lt;String, LabelNode&gt; labels = Maps.newTreeMap();</span>

    /**
     * These are the goto-statements in this scope.
     */
<span class="fc" id="L44">    private final List&lt;GotoStatement&gt; jumps = Lists.newLinkedList();</span>

    /**
     * These are the marker-statements in this scope.
     */
<span class="fc" id="L49">    private final List&lt;MarkerStatement&gt; markers = Lists.newLinkedList();</span>

    /**
     * These are the branch-statements in this scope.
     */
<span class="fc" id="L54">    private final List&lt;BranchStatement&gt; branches = Lists.newLinkedList();</span>

    /**
     * Sole Constructor.
     *
     * @param program is the program being compiled.
     */
    public LabelScope(final ProgramCompiler program)
<span class="fc" id="L62">    {</span>
<span class="fc" id="L63">        Preconditions.checkNotNull(program);</span>

<span class="fc" id="L65">        this.program = program;</span>
<span class="fc" id="L66">    }</span>

    /**
     * This method defers checking of a goto-statement.
     *
     * &lt;p&gt;
     * Deferring checking alleviates the need for yet another compiler pass.
     * &lt;/p&gt;
     *
     * @param statement is the goto-statement itself.
     */
    public void defer(final GotoStatement statement)
    {
<span class="fc" id="L79">        Preconditions.checkNotNull(statement);</span>

<span class="fc" id="L81">        jumps.add(statement);</span>
<span class="fc" id="L82">    }</span>

    /**
     * This method defers checking of a marker-statement.
     *
     * &lt;p&gt;
     * Deferring checking alleviates the need for yet another compiler pass.
     * &lt;/p&gt;
     *
     * @param statement is the marker-statement itself.
     */
    public void defer(final MarkerStatement statement)
    {
<span class="fc" id="L95">        Preconditions.checkNotNull(statement);</span>

<span class="fc" id="L97">        markers.add(statement);</span>
<span class="fc" id="L98">    }</span>

    /**
     * This method defers checking of a branch-statement.
     *
     * &lt;p&gt;
     * Deferring checking alleviates the need for yet another compiler pass.
     * &lt;/p&gt;
     *
     * @param statement is the marker-statement itself.
     */
    public void defer(final BranchStatement statement)
    {
<span class="fc" id="L111">        Preconditions.checkNotNull(statement);</span>

<span class="fc" id="L113">        branches.add(statement);</span>
<span class="fc" id="L114">    }</span>

    /**
     * This method performs the checking of goto-statements and marker-statements that was deferred.
     */
    public void check()
    {
<span class="fc bfc" id="L121" title="All 2 branches covered.">        for (MarkerStatement x : markers)</span>
        {
<span class="fc" id="L123">            checkMarker(x);</span>
<span class="fc" id="L124">        }</span>

<span class="fc bfc" id="L126" title="All 2 branches covered.">        for (GotoStatement x : jumps)</span>
        {
<span class="fc" id="L128">            checkGoto(x);</span>
<span class="fc" id="L129">        }</span>

<span class="fc bfc" id="L131" title="All 2 branches covered.">        for (BranchStatement x : branches)</span>
        {
<span class="fc" id="L133">            checkBranch(x);</span>
<span class="fc" id="L134">        }</span>
<span class="fc" id="L135">    }</span>

    private void checkMarker(final MarkerStatement statement)
    {
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (labels.containsKey(statement.getLabel().getName()))</span>
        {
<span class="nc" id="L141">            program.checker.reportDuplicateLabel(statement.getLabel());</span>
        }
        else
        {
<span class="fc" id="L145">            labels.put(statement.getLabel().getName(), new LabelNode());</span>
        }
<span class="fc" id="L147">    }</span>

    private void checkGoto(final GotoStatement statement)
    {
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if (labels.containsKey(statement.getLabel().getName()))</span>
        {
            // The statement is OK.
        }
        else
        {
<span class="nc" id="L157">            program.checker.reportUndeclaredLabel(statement.getLabel());</span>
        }
<span class="fc" id="L159">    }</span>

    private void checkBranch(final BranchStatement statement)
    {
        /**
         * Each of the case labels must be declared in the enclosing function.
         */
<span class="fc bfc" id="L166" title="All 2 branches covered.">        for (Label label : statement.getLabels())</span>
        {
<span class="fc bfc" id="L168" title="All 2 branches covered.">            if (labels.containsKey(label.getName()) == false)</span>
            {
<span class="nc" id="L170">                program.checker.reportUndeclaredLabel(statement.getDefaultLabel());</span>
            }
<span class="fc" id="L172">        }</span>

        /**
         * The label of the default-case must be declared in the enclosing function.
         */
<span class="fc bfc" id="L177" title="All 2 branches covered.">        if (labels.containsKey(statement.getDefaultLabel().getName()) == false)</span>
        {
<span class="nc" id="L179">            program.checker.reportUndeclaredLabel(statement.getDefaultLabel());</span>
        }
<span class="fc" id="L181">    }</span>

    /**
     * This method retrieves the bytecode node that implements the label.
     *
     * @param name is the name of the label to retrieve.
     * @return the bytecode for the node.
     * @throws IllegalStateException if the label was already declared.
     */
    public LabelNode nodeOf(final String name)
    {
<span class="fc" id="L192">        return labels.get(name);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>