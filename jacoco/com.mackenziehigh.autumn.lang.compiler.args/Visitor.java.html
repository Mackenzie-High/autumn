<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Visitor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.mackenziehigh:autumn</a> &gt; <a href="index.source.html" class="el_package">com.mackenziehigh.autumn.lang.compiler.args</a> &gt; <span class="el_source">Visitor.java</span></div><h1>Visitor.java</h1><pre class="source lang-java linenums">package com.mackenziehigh.autumn.lang.compiler.args;

import autumn.lang.compiler.AutumnProject;
import autumn.lang.compiler.errors.BasicErrorReporter;
import autumn.lang.exceptions.AssertionFailedException;
import autumn.lang.exceptions.AssumptionFailedException;
import autumn.util.test.TestResults;
import com.google.common.collect.Lists;
import com.google.common.io.Resources;
import com.mackenziehigh.autumn.Main;
import com.mackenziehigh.autumn.resources.Finished;
import com.mackenziehigh.snowflake.ITreeNode;
import java.io.File;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.charset.Charset;
import java.nio.file.NoSuchFileException;
import java.util.LinkedList;
import java.util.List;

/**
 * An instance of this class is used to process the command-line arguments given to the compiler.
 *
 * @author Mackenzie High
 */
@Finished(&quot;2014/08/22&quot;)
<span class="nc" id="L29">public final class Visitor</span>
        extends AbstractVisitor
{
    private static interface Invokable
    {
        public void invoke()
                throws Exception;
    }

    private static final String HELP = &quot;/com/mackenziehigh/autumn/resources/help.txt&quot;;

    private static final String LICENSE = &quot;/com/mackenziehigh/autumn/resources/license.txt&quot;;

    private static final String VERSION = &quot;/com/mackenziehigh/autumn/resources/version.txt&quot;;

    private String name;

    private static AutumnProject project;

    /**
     * These are the paths to the jar files.
     */
<span class="nc" id="L51">    private static final LinkedList&lt;File&gt; paths = Lists.newLinkedList();</span>

    /**
     * These are the command-line arguments to pass to the interpreted program.
     */
<span class="nc" id="L56">    private static final LinkedList&lt;String&gt; args = Lists.newLinkedList();</span>

    /**
     * This field is used to temporarily store a single argument.
     */
    private String argument;

    private void visitChildren(final ITreeNode node)
    {
<span class="nc bnc" id="L65" title="All 2 branches missed.">        for (ITreeNode kid : node.children())</span>
        {
<span class="nc" id="L67">            visit(kid);</span>
        }
<span class="nc" id="L69">    }</span>

    /**
     * This method resolves the project folder.
     *
     * &lt;p&gt;
     * Imagine that you try to run an Autumn project from somewhere deep within the project.
     * Autumn must resolve the outer most folder in the project folder.
     * That is precisely what this method does.
     * &lt;/p&gt;
     *
     * @return the resolved project folder.
     */
    private static File resolveProject()
    {
<span class="nc" id="L84">        File p = new File(System.getProperty(&quot;user.dir&quot;));</span>

<span class="nc bnc" id="L86" title="All 4 branches missed.">        while (isProject(p) == false &amp;&amp; p.getParent() != null)</span>
        {
<span class="nc" id="L88">            p = p.getParentFile();</span>
        }

<span class="nc" id="L91">        return p;</span>
    }

    /**
     * This method determines whether a folder is a project folder.
     *
     * @param folder is a possible project folder.
     * @return true, iff the file represents a project folder.
     */
    private static boolean isProject(final File folder)
    {
<span class="nc bnc" id="L102" title="All 2 branches missed.">        return folder.isDirectory()</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">               &amp;&amp; !folder.isHidden()</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">               &amp;&amp; new File(folder, &quot;src&quot;).exists()</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">               &amp;&amp; new File(folder, &quot;lib&quot;).exists()</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">               &amp;&amp; new File(folder, &quot;test&quot;).exists();</span>
    }

    /**
     * This method resolves the name of a file.
     *
     * &lt;p&gt;
     * The file may already be resolved, or the file may be in the current directory,
     * or the file may be in the home directory.
     * &lt;/p&gt;
     *
     * @param file is the file to resolve.
     * @return the actual path to the file.
     * @throws NoSuchFileException if the file cannot be found.
     */
    private static File resolve(final File file)
            throws NoSuchFileException
    {
<span class="nc" id="L124">        final File CURRENT = new File(System.getProperty(&quot;user.dir&quot;));</span>

<span class="nc" id="L126">        final File HOME = new File(System.getProperty(&quot;user.home&quot;));</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">        final boolean atom = file.getPath().contains(System.getProperty(&quot;file.separator&quot;)) == false;</span>

<span class="nc" id="L130">        final File possibility1 = new File(CURRENT, file.getName());</span>

<span class="nc" id="L132">        final File possibility2 = new File(HOME, file.getName());</span>

<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (file.exists())</span>
        {
<span class="nc" id="L136">            return file;</span>
        }
<span class="nc bnc" id="L138" title="All 4 branches missed.">        else if (atom &amp;&amp; possibility1.exists())</span>
        {
<span class="nc" id="L140">            return possibility1;</span>
        }
<span class="nc bnc" id="L142" title="All 4 branches missed.">        else if (atom &amp;&amp; possibility2.exists())</span>
        {
<span class="nc" id="L144">            return possibility2;</span>
        }
        else
        {
<span class="nc" id="L148">            throw new NoSuchFileException(file.toString());</span>
        }
    }

    /**
     * This method generalizes the running of a project.
     *
     * &lt;p&gt;
     * This method alleviates the need for separate complex methods
     * for running, testing, and debugging Autumn programs.
     * &lt;/p&gt;
     *
     * @param function is used to invoke the appropriate method in the Autumn object.
     */
    private static void run(final Invokable function)
    {
        /**
         * Load the project.
         */
<span class="nc" id="L167">        final File folder = resolveProject();</span>
<span class="nc" id="L168">        final BasicErrorReporter reporter = new BasicErrorReporter(System.out);</span>
<span class="nc" id="L169">        project = new AutumnProject(folder, reporter);</span>

        /**
         * Execute the script.
         */
        try
        {
<span class="nc" id="L176">            function.invoke();</span>
        }
<span class="nc" id="L178">        catch (ClassNotFoundException ex)</span>
        {
<span class="nc" id="L180">            System.out.println(&quot;The main-class could not be found.&quot;);</span>
<span class="nc" id="L181">            ex.printStackTrace(System.out);</span>
        }
<span class="nc" id="L183">        catch (NoSuchMethodException ex)</span>
        {
<span class="nc" id="L185">            System.out.println(&quot;The main(String[]) function could not be found.&quot;);</span>
<span class="nc" id="L186">            ex.printStackTrace(System.out);</span>
        }
<span class="nc" id="L188">        catch (InvocationTargetException ex)</span>
        {
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (ex.getCause() instanceof AssertionFailedException)</span>
            {
<span class="nc" id="L192">                System.out.println(&quot;Assertion Failed:&quot;);</span>
<span class="nc" id="L193">                System.out.println(&quot;  File: &quot; + ((AssertionFailedException) ex.getCause()).file());</span>
<span class="nc" id="L194">                System.out.println(&quot;  Line: &quot; + ((AssertionFailedException) ex.getCause()).line());</span>
            }

<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (ex.getCause() instanceof AssumptionFailedException)</span>
            {
<span class="nc" id="L199">                System.out.println(&quot;Assumption Failed:&quot;);</span>
<span class="nc" id="L200">                System.out.println(&quot;  File: &quot; + ((AssumptionFailedException) ex.getCause()).file());</span>
<span class="nc" id="L201">                System.out.println(&quot;  Line: &quot; + ((AssumptionFailedException) ex.getCause()).line());</span>
            }

<span class="nc" id="L204">            ex.getCause().printStackTrace(System.out);</span>
        }
<span class="nc" id="L206">        catch (IllegalAccessException ex)</span>
        {
<span class="nc" id="L208">            ex.printStackTrace(System.out);</span>
        }
<span class="nc" id="L210">        catch (MalformedURLException ex)</span>
        {
<span class="nc" id="L212">            ex.printStackTrace(System.out);</span>
        }
<span class="nc" id="L214">        catch (Exception ex)</span>
        {
<span class="nc" id="L216">            ex.printStackTrace(System.out);</span>
<span class="nc" id="L217">        }</span>
<span class="nc" id="L218">    }</span>

    public void printHelp()
    {
<span class="nc" id="L222">        final URL url = Resources.getResource(Main.class, HELP);</span>

        try
        {
<span class="nc" id="L226">            System.out.println(Resources.toString(url, Charset.defaultCharset()));</span>
        }
<span class="nc" id="L228">        catch (Exception ex)</span>
        {
<span class="nc" id="L230">            ex.printStackTrace(System.out);</span>
<span class="nc" id="L231">            return;</span>
<span class="nc" id="L232">        }</span>
<span class="nc" id="L233">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visitUnknown(final ITreeNode node)
    {
<span class="nc" id="L241">        visitChildren(node);</span>
<span class="nc" id="L242">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_case_help(final ITreeNode node)
    {
<span class="nc" id="L250">        printHelp();</span>
<span class="nc" id="L251">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_case_version(final ITreeNode node)
    {
<span class="nc" id="L259">        final URL url = Resources.getResource(Main.class, VERSION);</span>

        try
        {
<span class="nc" id="L263">            System.out.println(Resources.toString(url, Charset.defaultCharset()));</span>
        }
<span class="nc" id="L265">        catch (Exception ex)</span>
        {
<span class="nc" id="L267">            ex.printStackTrace(System.out);</span>
<span class="nc" id="L268">            return;</span>
<span class="nc" id="L269">        }</span>
<span class="nc" id="L270">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_case_license(final ITreeNode node)
    {
<span class="nc" id="L278">        final URL url = Resources.getResource(Main.class, LICENSE);</span>

        try
        {
<span class="nc" id="L282">            System.out.println(Resources.toString(url, Charset.defaultCharset()));</span>
        }
<span class="nc" id="L284">        catch (Exception ex)</span>
        {
<span class="nc" id="L286">            ex.printStackTrace(System.out);</span>
<span class="nc" id="L287">            return;</span>
<span class="nc" id="L288">        }</span>
<span class="nc" id="L289">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_case_run(final ITreeNode node)
    {
<span class="nc" id="L297">        visitChildren(node);</span>

<span class="nc" id="L299">        final Invokable function = new Invokable()</span>
<span class="nc" id="L300">        {</span>
            @Override
            public void invoke()
                    throws ClassNotFoundException,
                           NoSuchMethodException,
                           InvocationTargetException,
                           IllegalAccessException,
                           IOException
            {
                /**
                 * Run the program.
                 */
<span class="nc" id="L312">                project.run(args.toArray(new String[0]));</span>
<span class="nc" id="L313">            }</span>
        };

<span class="nc" id="L316">        run(function);</span>
<span class="nc" id="L317">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_case_test(final ITreeNode node)
    {
<span class="nc" id="L325">        visitChildren(node);</span>

<span class="nc" id="L327">        final Invokable function = new Invokable()</span>
<span class="nc" id="L328">        {</span>
            @Override
            public void invoke()
                    throws ClassNotFoundException,
                           NoSuchMethodException,
                           InvocationTargetException,
                           IllegalAccessException,
                           IOException
            {
<span class="nc" id="L337">                final TestResults results = project.test();</span>

<span class="nc" id="L339">                results.print(System.out);</span>
<span class="nc" id="L340">            }</span>
        };

<span class="nc" id="L343">        run(function);</span>
<span class="nc" id="L344">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_case_execute(final ITreeNode node)
    {
<span class="nc" id="L352">        visitChildren(node);</span>

<span class="nc" id="L354">        final Invokable function = new Invokable()</span>
<span class="nc" id="L355">        {</span>
            @Override
            public void invoke()
                    throws Exception
            {
<span class="nc" id="L360">                final List&lt;File&gt; jars = new LinkedList&lt;File&gt;();</span>

<span class="nc bnc" id="L362" title="All 2 branches missed.">                for (File path : paths)</span>
                {
<span class="nc" id="L364">                    jars.add(resolve(path));</span>
<span class="nc" id="L365">                }</span>

<span class="nc" id="L367">                AutumnProject.execute(jars, args.toArray(new String[0]));</span>
<span class="nc" id="L368">            }</span>
        };

<span class="nc" id="L371">        run(function);</span>
<span class="nc" id="L372">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_case_compile(final ITreeNode node)
    {
<span class="nc" id="L380">        visitChildren(node);</span>

        try
        {
<span class="nc" id="L384">            final File userdir = new File(System.getProperty(&quot;user.dir&quot;));</span>

<span class="nc" id="L386">            final AutumnProject project = new AutumnProject(userdir, new BasicErrorReporter(System.out));</span>

<span class="nc" id="L388">            project.compile();</span>
        }
<span class="nc" id="L390">        catch (IOException ex)</span>
        {
<span class="nc" id="L392">            System.out.println(&quot;Error - The project could not be compiled.&quot;);</span>
<span class="nc" id="L393">            ex.printStackTrace(System.out);</span>
<span class="nc" id="L394">        }</span>
<span class="nc" id="L395">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_case_create(final ITreeNode node)
    {
<span class="nc" id="L403">        visitChildren(node);</span>

        try
        {
<span class="nc" id="L407">            final File userdir = new File(System.getProperty(&quot;user.dir&quot;));</span>

<span class="nc" id="L409">            System.out.println(&quot;Current Directory = &quot; + userdir);</span>
<span class="nc" id="L410">            System.out.println(&quot;Project Name = &quot; + name);</span>

<span class="nc" id="L412">            AutumnProject.create(new File(userdir, name));</span>
        }
<span class="nc" id="L414">        catch (IOException ex)</span>
        {
<span class="nc" id="L416">            System.out.println(&quot;Error - The project could not be created.&quot;);</span>
<span class="nc" id="L417">            ex.printStackTrace(System.out);</span>
<span class="nc" id="L418">        }</span>
<span class="nc" id="L419">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_name(final ITreeNode node)
    {
<span class="nc" id="L427">        visitChildren(node);</span>

<span class="nc" id="L429">        name = args.get(0).trim();</span>
<span class="nc" id="L430">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_path(final ITreeNode node)
    {
<span class="nc" id="L438">        visitChildren(node);</span>

<span class="nc" id="L440">        paths.add(new File(args.pollLast()));</span>
<span class="nc" id="L441">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_arg(final ITreeNode node)
    {
<span class="nc" id="L449">        visitChildren(node);</span>

<span class="nc" id="L451">        args.add(argument);</span>
<span class="nc" id="L452">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_qstring(final ITreeNode node)
    {
<span class="nc" id="L460">        final String text = node.childAt(2).text().substring(0, node.childAt(2).text().length());</span>

<span class="nc" id="L462">        argument = text;</span>
<span class="nc" id="L463">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_pstring(final ITreeNode node)
    {
<span class="nc" id="L471">        final String text = node.childAt(1).text();</span>

<span class="nc" id="L473">        argument = text;</span>
<span class="nc" id="L474">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void visit_error(final ITreeNode node)
    {
<span class="nc" id="L482">        printHelp();</span>
<span class="nc" id="L483">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>