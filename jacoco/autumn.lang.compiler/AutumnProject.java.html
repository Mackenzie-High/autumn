<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AutumnProject.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.mackenziehigh:autumn</a> &gt; <a href="index.source.html" class="el_package">autumn.lang.compiler</a> &gt; <span class="el_source">AutumnProject.java</span></div><h1>AutumnProject.java</h1><pre class="source lang-java linenums">package autumn.lang.compiler;

import autumn.lang.compiler.errors.IErrorReporter;
import autumn.util.FileIO;
import autumn.util.test.TestResults;
import com.google.common.base.Preconditions;
import com.google.common.collect.Lists;
import com.google.common.io.Files;
import com.google.common.io.Resources;
import java.io.File;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLClassLoader;
import java.nio.charset.Charset;
import java.util.Collections;
import java.util.List;
import java.util.jar.Attributes;
import java.util.jar.JarFile;

/**
 * &lt;b&gt;(Under Active Development)&lt;/b&gt; - An instance of this class represents an Autumn project.
 *
 * @author Mackenzie High
 */
public final class AutumnProject
{
    /**
     * This is the path to the directory containing the Autumn project.
     *
     * &lt;p&gt;
     * The directory has several important subdirectories, including &quot;src&quot;, &quot;test&quot;, and &quot;lib&quot;.
     * &lt;/p&gt;
     */
    private final File project;

    /**
     * This is the path to the JAR-file representation of the project, if any.
     */
    private final File program;

    /**
     * This object is used to report compilation errors.
     */
    private final IErrorReporter reporter;

    /**
     * Sole Constructor.
     *
     * @param project is the directory that contains the Autumn-based project.
     * @param reporter is used to report compilation errors.
     * @throws NullPointerException if project is null.
     * @throws NullPointerException if reporter is null.
     * @throws IllegalArgumentException if project does not refer to a directory.
     */
    public AutumnProject(final File project,
                         final IErrorReporter reporter)
<span class="nc" id="L60">    {</span>
<span class="nc" id="L61">        Preconditions.checkNotNull(project);</span>
<span class="nc" id="L62">        Preconditions.checkNotNull(reporter);</span>
<span class="nc" id="L63">        Preconditions.checkArgument(project.isDirectory());</span>

<span class="nc" id="L65">        this.project = project;</span>
<span class="nc" id="L66">        this.program = new File(project, &quot;program.jar&quot;);</span>
<span class="nc" id="L67">        this.reporter = reporter;</span>
<span class="nc" id="L68">    }</span>

    /**
     * This method enumerates all the source-code files in the project.
     *
     * @return the aforedescribed immutable list.
     */
    public List&lt;File&gt; srcFiles()
    {
<span class="nc" id="L77">        return filesOf(new File(project, &quot;src/&quot;), &quot;.leaf&quot;);</span>
    }

    /**
     * This method enumerates all the test-code files in the project.
     *
     * @return the aforedescribed immutable list.
     */
    public List&lt;File&gt; testFiles()
    {
<span class="nc" id="L87">        return filesOf(new File(project, &quot;test/&quot;), &quot;.leaf&quot;);</span>
    }

    /**
     * This method enumerates all the library jar-files in the project.
     *
     * @return the aforedescribed immutable list.
     */
    public List&lt;File&gt; libFiles()
    {
<span class="nc" id="L97">        return filesOf(new File(project, &quot;lib/&quot;), &quot;.jar&quot;);</span>
    }

    /**
     * This method creates a list of all the files with a certain extension in a directory.
     *
     * &lt;p&gt;
     * The list will include files in subdirectories.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Hidden files are simply ignored.
     * &lt;/p&gt;
     *
     * @param folder is the root directory.
     * @param extension is the file extension of each file.
     * @return the aforedescribed immutable list.
     */
    private List&lt;File&gt; filesOf(final File folder,
                               final String extension)
    {
<span class="nc" id="L118">        final List&lt;File&gt; files = Lists.newLinkedList();</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        for (File file : FileIO.filesOf(folder, true))</span>
        {
<span class="nc bnc" id="L122" title="All 6 branches missed.">            if (!file.isHidden() &amp;&amp; file.isFile() &amp;&amp; file.getPath().endsWith(extension))</span>
            {
<span class="nc" id="L124">                files.add(file);</span>
            }
<span class="nc" id="L126">        }</span>

<span class="nc" id="L128">        return Collections.unmodifiableList(files);</span>
    }

    /**
     * This method compiles the project and outputs a jar-file.
     *
     * &lt;p&gt;
     * The name of the jar-file is always &quot;program.jar&quot;.
     * The jar-file will be placed in the root directory of the project.
     * &lt;/p&gt;
     *
     * @throws IOException if an IO error occurs.
     */
    public void compile()
            throws IOException
    {
        /**
         * Load the project.
         */
<span class="nc" id="L147">        final Autumn autumn = load();</span>

        /**
         * Compile the project and then create the resulting JAR file.
         */
<span class="nc" id="L152">        autumn.compile(program);</span>
<span class="nc" id="L153">    }</span>

    /**
     * This method dynamically compiles and then runs a project.
     *
     * @param args are the command-line arguments to pass to the program.
     * @throws IOException if an IO error occurs.
     * @throws ClassNotFoundException if the main module of the project cannot be found.
     * @throws NoSuchMethodException if the project does not contain a valid entry-point.
     * @throws InvocationTargetException if the entry-point function throws an exception.
     * @throws IllegalAccessException
     */
    public void run(final String[] args)
            throws IOException,
                   ClassNotFoundException,
                   NoSuchMethodException,
                   InvocationTargetException,
                   IllegalAccessException
    {
        /**
         * Load the project.
         */
<span class="nc" id="L175">        final Autumn autumn = load();</span>

        /**
         * Execute the program.
         */
<span class="nc" id="L180">        autumn.run(args);</span>
<span class="nc" id="L181">    }</span>

    /**
     * This method dynamically compiles and then runs the unit-tests of a project.
     *
     * @return the results of running the unit-tests.
     * @throws IOException if an IO error occurs.
     */
    public TestResults test()
            throws IOException
    {
        /**
         * Load the project.
         */
<span class="nc" id="L195">        final Autumn autumn = load();</span>

        /**
         * Test the program.
         */
<span class="nc" id="L200">        final TestResults results = autumn.test();</span>

        /**
         * Return the results of the unit-testing.
         */
<span class="nc" id="L205">        return results;</span>
    }

    public void execute(final String[] args)
            throws MalformedURLException,
                   IOException,
                   ClassNotFoundException,
                   IllegalAccessException,
                   IllegalArgumentException,
                   InvocationTargetException,
                   NoSuchMethodException
    {
<span class="nc" id="L217">        final List&lt;File&gt; jars = Lists.newArrayList();</span>

<span class="nc" id="L219">        jars.add(program);</span>

<span class="nc" id="L221">        jars.addAll(libFiles());</span>

<span class="nc" id="L223">        execute(jars, args);</span>
<span class="nc" id="L224">    }</span>

    public static void execute(final List&lt;File&gt; program,
                               final String[] args)
            throws MalformedURLException,
                   IOException,
                   ClassNotFoundException,
                   IllegalAccessException,
                   IllegalArgumentException,
                   InvocationTargetException,
                   NoSuchMethodException
    {
        /**
         * Step 1. Load all the jar files.
         */
<span class="nc" id="L239">        final URL[] jars = new URL[program.size()];</span>

<span class="nc" id="L241">        int i = 0;</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">        for (File jar : program)</span>
        {
<span class="nc" id="L245">            jars[i++] = jar.toURI().toURL();</span>
<span class="nc" id="L246">        }</span>

<span class="nc" id="L248">        final URLClassLoader loader = new URLClassLoader(jars);</span>

        /**
         * Step 2. Find the main class.
         */
<span class="nc" id="L253">        String name = null;</span>

<span class="nc bnc" id="L255" title="All 2 branches missed.">        for (File jar : program)</span>
        {
<span class="nc" id="L257">            name = new JarFile(jar).getManifest().getMainAttributes().getValue(Attributes.Name.MAIN_CLASS);</span>
<span class="nc" id="L258">        }</span>

<span class="nc" id="L260">        final Class klass = Class.forName(name, true, loader);</span>


        /**
         * Reflectively find the main function.
         */
<span class="nc" id="L266">        final Method main = klass.getMethod(&quot;main&quot;, String[].class);</span>

        /**
         * Invoke the main function.
         */
<span class="nc" id="L271">        main.invoke(null, (Object) args);</span>
<span class="nc" id="L272">    }</span>

    public Autumn load()
            throws IOException
    {
        /**
         * Create the object that will actually perform the execution.
         */
<span class="nc" id="L280">        final Autumn autumn = new Autumn();</span>
<span class="nc" id="L281">        autumn.setErrorReporter(reporter);</span>

        /**
         * Load all of the library files.
         */
<span class="nc bnc" id="L286" title="All 2 branches missed.">        for (File library : libFiles())</span>
        {
<span class="nc" id="L288">            autumn.loadFile(library);</span>
<span class="nc" id="L289">        }</span>

        /**
         * Read all of the source-code files.
         */
<span class="nc bnc" id="L294" title="All 2 branches missed.">        for (File src : srcFiles())</span>
        {
<span class="nc" id="L296">            autumn.srcFile(src);</span>
<span class="nc" id="L297">        }</span>

        /**
         * Read all of the test-code files.
         */
<span class="nc bnc" id="L302" title="All 2 branches missed.">        for (File test : testFiles())</span>
        {
<span class="nc" id="L304">            autumn.srcFile(test);</span>
<span class="nc" id="L305">        }</span>

<span class="nc" id="L307">        return autumn;</span>
    }

    public static void create(final File project)
            throws IOException
    {
<span class="nc" id="L313">        Preconditions.checkNotNull(project);</span>

        URL url;
        String code;

        /**
         * Create the project folder itself.
         */
<span class="nc" id="L321">        project.mkdirs();</span>

        /**
         * Create the project/src directory.
         */
<span class="nc" id="L326">        final File src = new File(project, &quot;src&quot;);</span>
<span class="nc" id="L327">        src.mkdirs();</span>

        /**
         * Create the project/test directory.
         */
<span class="nc" id="L332">        final File test = new File(project, &quot;test&quot;);</span>
<span class="nc" id="L333">        test.mkdirs();</span>

        /**
         * Create the project/lib directory.
         */
<span class="nc" id="L338">        final File lib = new File(project, &quot;lib&quot;);</span>
<span class="nc" id="L339">        lib.mkdirs();</span>

        /**
         * Create the project/src/Main.leaf file.
         */
<span class="nc" id="L344">        url = Resources.getResource(Autumn.class, &quot;/com/mackenziehigh/autumn/resources/default-src-main.leaf&quot;);</span>
<span class="nc" id="L345">        code = Resources.toString(url, Charset.defaultCharset());</span>

<span class="nc" id="L347">        final File src_main = new File(src, &quot;Main.leaf&quot;);</span>
<span class="nc" id="L348">        Files.write(code, src_main, Charset.defaultCharset());</span>

        /**
         * Create the project/test/MainTest.leaf file.
         */
<span class="nc" id="L353">        url = Resources.getResource(Autumn.class, &quot;/com/mackenziehigh/autumn/resources/default-test-main.leaf&quot;);</span>
<span class="nc" id="L354">        code = Resources.toString(url, Charset.defaultCharset());</span>

<span class="nc" id="L356">        final File test_main = new File(test, &quot;MainTest.leaf&quot;);</span>
<span class="nc" id="L357">        Files.write(code, test_main, Charset.defaultCharset());</span>
<span class="nc" id="L358">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>